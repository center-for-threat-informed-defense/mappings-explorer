{% extends "base.html.j2" %} {% block content %}
<div id="search">
  <Search></Search>
</div>

<script src="{{url_prefix}}static/lunr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table-vue.min.js"></script>


<script>
  const Search = {
    template: `
      <div v-if="filteredMappings.length">
        <section id="header-container" class="header-container">
          <div class="container" data-aos="fade-up">
            <h1 style="text-transform: uppercase">
              <span class="highlight">Search Result</span> Mappings
            </h1>
          </div>
        </section>
        <section class="mapping-table">
          <div class="container" data-aos="fade-up">
            <div class="row justify-content-left">
              <div class="table-responsive table-outer">
                <div class="form-outline mb-4">
                  <bootstrap-table class="table-borderless" :columns="headers" :data="filteredMappings" :options="options"></bootstrap-table>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
  `,
    delimiters: ["[[", "]]"],
    components: {
      'BootstrapTable': BootstrapTable
    },
    data() {
      return {
        webPages: undefined,
        index: undefined,
        filteredMappings: [],
        options: {
          search: true,
          pagination: true,
          sortable: true,
        },
        headers: [
          {
            field: "mapping_framework",
            title: "Mapping Framework",
            sortable: true,
          },
          {
            field: "attack_object_id",
            title: "ATT&CK ID",
            sortable: true,
          },
          {
            field: "attack_object_name",
            title: "ATT&CK Name",
            sortable: true,
          },
          {
            field: "mapping_type",
            title: "Mapping Type",
            sortable: true,
          },
          {
            field: "capability_id",
            title: "Capability ID",
            sortable: true,
          },
          {
            field: "capability_description",
            title: "Capability Description",
            sortable: true,
          },
        ],

      };
    },
    methods: {
      /**
       * Initialize the search index.
       */
      async initializeSearch(indexUrl) {
        const indexResponse = await fetch(indexUrl);
        const indexJson = await indexResponse.json();
        this.webPages = indexJson["pages"];
        this.index = lunr.Index.load(indexJson["index"]);
        console.log("Search index is initialized.");
      },

      /**
       * Run a query on the search index and return the results.
       */
      searchIndex(query, page = 1) {
        if (!this.index) {
          console.error("Search index is not initialized.");
          return;
        }

        const allResults = this.index.search(query);

        // TODO paginate the results using `page` and `resultsPerPage`.
        const startAt = 0;
        const endAt = 10;
        const results = allResults.slice(startAt, endAt);
        for (const result of results) {
          result.pageData = this.webPages[result.ref];
        }

        return {
          query,
          results: results,
          totalCount: allResults.length,
        };
      },
      async getAllMappings(){
        let allMappingsURL = `${window.location.origin}/static/all_mappings.json`;
        const response = await fetch(allMappingsURL);
        const responseJSON = await response.json();
        return responseJSON;
      },
      async searchMain() {
        const url = new URL(window.location.href);
        let allMappings = await this.getAllMappings();
        if (url.searchParams.has("search")) {
          let search = url.searchParams.get("search");
          document.getElementById("search-input").value = search;
          this.initializeSearch(
            `${window.location.origin}/static/lunr-index.json`
          ).then(() => {
            let results = this.searchIndex(search, 1);
            let filteredMappings = [];
            results.results.forEach((result) => {
              filteredMappings.push(
                allMappings.filter((mapping) => {
                  return (
                    mapping.attack_object_id?.includes(result.pageData.id) ||
                    mapping.group?.includes(result.pageData.id) ||
                    mapping.capability_id?.includes(result.pageData.id)
                  );
                })
              );
            });
            this.filteredMappings = filteredMappings.flat();
          });
        }
      },
    },
    mounted() {
      this.searchMain();
    },
  };

  const app = new Vue({
    el: "#search",
    components: {
      Search: Search,
    },
  });
</script>
<style></style>
{% endblock content %}
